# 从 PromeFuzz 改进到 RustFuzz 的技术文档

## 概述

RustFuzz 是基于 PromeFuzz 框架专门针对 Rust 生态系统优化的 Fuzzing 工具。本文档说明了两者的主要差异和改进点。

## 主要改进

### 1. 语言特性支持

#### Rust 特有特性
- **所有权系统**: 生成的代码考虑 Rust 的所有权和借用规则
- **生命周期**: 正确处理生命周期标注
- **Trait 系统**: 支持 trait bounds 和泛型约束
- **Unsafe 分析**: 特别关注 unsafe 代码块的测试

#### 与 C/C++ 的差异
- C/C++ 主要关注内存安全（缓冲区溢出、UAF）
- Rust 关注逻辑错误、panic、unsafe 代码安全性

### 2. 代码分析优化

#### AST 解析
- 使用 `tree-sitter-rust` 替代 C/C++ 解析器
- 提取 Rust 特有语法结构：
  - `impl` 块
  - `trait` 定义
  - 模式匹配
  - 宏调用

#### 类型系统
- 支持 Rust 复杂类型系统：
  - Option/Result
  - 泛型参数
  - 关联类型
  - Trait 对象

### 3. Fuzz Target 生成

#### libfuzzer 集成
```rust
// RustFuzz 生成的标准格式
#![no_main]
use libfuzzer_sys::fuzz_target;
use arbitrary::Arbitrary;

fuzz_target!(|data: &[u8]| {
    // 测试代码
});
```

#### Arbitrary 支持
- 自动生成 `Arbitrary` trait 实现
- 支持结构化输入生成
- 处理复杂数据结构

### 4. Prompt 工程优化

#### Rust 专用 Prompt
```
原 PromeFuzz (C/C++):
"Generate a fuzz harness that tests memory safety..."

RustFuzz (Rust):
"Generate a fuzz target that:
1. Uses libfuzzer_sys::fuzz_target! macro
2. Handles Result/Option types properly
3. Tests error conditions and panics
4. Respects ownership and borrowing rules
5. Focuses on logical errors in unsafe blocks"
```

### 5. 构建系统集成

#### Cargo 集成
- 自动生成 `Cargo.toml` 配置
- 管理依赖和 features
- 与 `cargo-fuzz` 无缝集成

vs PromeFuzz (CMake/Make):
- 需要手动配置编译选项
- 处理复杂的链接依赖

### 6. Sanitizer 适配

#### Rust 专用 Sanitizer
- AddressSanitizer: 检测 unsafe 代码的内存错误
- MemorySanitizer: 未初始化内存使用
- ThreadSanitizer: 并发安全性

配置简化:
```toml
[fuzzer]
sanitizers = ["address"]  # 自动添加到 rustflags
```

## 架构对比

### PromeFuzz 架构
```
Preprocessor (C/C++) → Comprehender → Generator → Analyzer
    ↓
  Bear/LLVM
    ↓
compile_commands.json
```

### RustFuzz 架构
```
Preprocessor (Rust) → Comprehender → Generator → Fuzzer → Analyzer
    ↓                                      ↓
tree-sitter-rust                    cargo-fuzz
    ↓                                      ↓
   AST                              libFuzzer
```

## 文件结构对比

### PromeFuzz
```
processor/
  cxx/         # C++ 处理器
  rust/        # Rust 处理器（基础版本）
src/
  preprocessor/
  generator/
    - 通用生成器
    - C/C++ prompter
```

### RustFuzz
```
processor/
  rust_analyzer.py  # 专用 Rust 分析器
src/
  generator/
    rust_generator.py  # Rust 专用生成器
  llm/
    llm.py  # 简化的 LLM 接口
```

## 配置差异

### PromeFuzz (C/C++)
```toml
[library]
compile_commands_path = "build/compile_commands.json"
header_paths = ["include/lib.h"]
driver_build_args = ["lib.a", "-lz"]
```

### RustFuzz
```toml
[library]
crate_path = "/path/to/crate"
source_paths = ["src"]
features = ["serde", "tokio"]
# 无需手动配置编译选项
```

## Prompt 模板差异

### PromeFuzz C++ Prompt
```
Generate a C++ fuzz harness using libFuzzer.
Requirements:
- Include necessary headers
- Implement LLVMFuzzerTestOneInput
- Handle memory allocation
- Check buffer boundaries
```

### RustFuzz Prompt
```
Generate a Rust fuzz target using cargo-fuzz.
Requirements:
- Use fuzz_target! macro
- Handle Result/Option properly
- Test panic conditions
- Use Arbitrary for complex inputs
- Focus on unsafe block safety
```

## 工作流程差异

### PromeFuzz 工作流
1. 配置 compile_commands.json
2. 运行 preprocessor 提取 API
3. 生成 C/C++ fuzz driver
4. 手动编译和链接
5. 运行 fuzzer

### RustFuzz 工作流
1. 配置 crate 路径
2. 自动分析 Rust 代码
3. 生成 fuzz target
4. cargo-fuzz 自动构建
5. 一键运行 fuzzing

## 优势总结

### RustFuzz 优势
1. **简化配置**: 无需 compile_commands.json
2. **自动构建**: cargo-fuzz 处理所有编译
3. **类型安全**: 利用 Rust 类型系统
4. **更好的集成**: 与 Rust 生态无缝对接
5. **专注性**: 针对 Rust 特有问题

### PromeFuzz 优势
1. **成熟度**: 经过大量 C/C++ 项目验证
2. **通用性**: 支持多种语言
3. **完整性**: 包含更多分析功能
4. **研究性**: 论文支持，学术认可

## 使用场景

### 使用 RustFuzz
- Rust crate 安全测试
- unsafe 代码审计
- FFI 接口验证
- Rust 生态依赖审计

### 使用 PromeFuzz
- C/C++ 库 fuzzing
- 跨语言项目
- 需要详细的 API 关联分析
- 学术研究

## 未来改进方向

### 短期目标
1. 完善 Arbitrary 自动生成
2. 改进 unsafe 代码检测
3. 增加 async/await 支持
4. 优化 prompt 模板

### 长期目标
1. 支持增量 fuzzing
2. 智能 corpus 管理
3. 自动化漏洞分析
4. 集成符号执行

## 迁移指南

### 从 PromeFuzz 迁移到 RustFuzz

1. **配置转换**
```bash
# PromeFuzz
compile_commands_path = "build/compile_commands.json"

# RustFuzz
crate_path = "/path/to/crate"
```

2. **命令对应**
```bash
# PromeFuzz
./PromeFuzz.py preprocess -L mylib
./PromeFuzz.py generate -L mylib

# RustFuzz
python RustFuzz.py preprocess -L mylib
python RustFuzz.py generate -L mylib
```

3. **输出格式**
- PromeFuzz: 生成 `.cpp` 文件
- RustFuzz: 生成 `.rs` 文件

## 结论

RustFuzz 是 PromeFuzz 理念在 Rust 生态系统的专业化实现。通过针对 Rust 特性的优化，提供了更简单、高效的 Rust fuzzing 解决方案。

适用场景:
- ✅ Rust 项目 → RustFuzz
- ✅ C/C++ 项目 → PromeFuzz
- ✅ 混合项目 → 根据主要语言选择
