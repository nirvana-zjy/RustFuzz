# RustFuzz å®Œæ•´ä½¿ç”¨æ•™ç¨‹

## ç›®å½•
1. [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
2. [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
3. [å®Œæ•´å·¥ä½œæµç¨‹](#å®Œæ•´å·¥ä½œæµç¨‹)
4. [å®æˆ˜æ¡ˆä¾‹](#å®æˆ˜æ¡ˆä¾‹)
5. [é«˜çº§æŠ€å·§](#é«˜çº§æŠ€å·§)
6. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ç¯å¢ƒå‡†å¤‡

### 1. å®‰è£… Rust å·¥å…·é“¾

```bash
# å®‰è£… Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# å®‰è£… nightly (cargo-fuzz éœ€è¦)
rustup install nightly
rustup default nightly

# å®‰è£… cargo-fuzz
cargo install cargo-fuzz
```

### 2. å®‰è£… Python ç¯å¢ƒ

```bash
# æ¨èä½¿ç”¨ Python 3.10+
python --version

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### 3. é…ç½® LLM

#### é€‰é¡¹ A: ä½¿ç”¨ OpenAI API

ç¼–è¾‘ `config.toml`:

```toml
[llm]
openai_api_key = "sk-your-api-key-here"
openai_api_base = "https://api.openai.com/v1"
openai_model = "gpt-4"
use_ollama = false
```

#### é€‰é¡¹ B: ä½¿ç”¨ Ollama æœ¬åœ°æ¨¡å‹

```bash
# å®‰è£… Ollama
curl https://ollama.ai/install.sh | sh

# ä¸‹è½½æ¨¡å‹
ollama pull codellama:13b
# æˆ–
ollama pull deepseek-coder:33b
```

ç¼–è¾‘ `config.toml`:

```toml
[llm]
use_ollama = true
ollama_host = "http://localhost:11434"
ollama_model = "codellama:13b"
```

---

## é…ç½®è¯´æ˜

### config.toml - å…¨å±€é…ç½®

```toml
[llm]
# LLM é…ç½®
openai_api_key = ""
openai_model = "gpt-4"

[preprocessor]
# æ˜¯å¦æå–æµ‹è¯•ç”¨ä¾‹ä½œä¸ºç¤ºä¾‹
extract_test_cases = true
# æ˜¯å¦åˆ†æ unsafe ä»£ç 
analyze_unsafe_blocks = true

[generator]
# æ¯ä¸ª fuzz target åŒ…å«çš„å‡½æ•°æ•°é‡
function_set_size = 3
# æœ€å¤§ç”Ÿæˆè½®æ¬¡
max_rounds = 50
# æ˜¯å¦ä¼˜å…ˆæµ‹è¯• unsafe å‡½æ•°
prioritize_unsafe = true

[fuzzer]
# Fuzzing å¼•æ“
engine = "libfuzzer"
# å•ä¸ª target è¿è¡Œæ—¶é—´ï¼ˆç§’ï¼‰
timeout = 3600
# Sanitizer
sanitizers = ["address"]
```

### libraries.toml - ç›®æ ‡åº“é…ç½®

```toml
[your_crate]
language = "rust"
crate_path = "/path/to/your/crate"
source_paths = ["src"]
test_paths = ["tests"]
output_path = "output/your_crate"

# å¯é€‰é…ç½®
target_modules = []
exclude_paths = ["benches", "examples"]
features = []
api_hints = []
```

---

## å®Œæ•´å·¥ä½œæµç¨‹

### ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–é…ç½®

```bash
# åˆ›å»ºé»˜è®¤é…ç½®ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
python RustFuzz.py configure --init

# ç¼–è¾‘ config.toml å’Œ libraries.toml
# å¡«å†™ LLM API å¯†é’¥å’Œç›®æ ‡ crate è·¯å¾„
```

### ç¬¬äºŒæ­¥ï¼šé¢„å¤„ç†é˜¶æ®µ

åˆ†æç›®æ ‡ crate çš„ä»£ç ç»“æ„ï¼š

```bash
python RustFuzz.py preprocess -L your_crate
```

è¿™ä¸€æ­¥ä¼šï¼š
- è§£ææ‰€æœ‰ Rust æºæ–‡ä»¶
- æå–å‡½æ•°ã€ç»“æ„ä½“ã€æšä¸¾ã€trait å®šä¹‰
- è¯†åˆ« unsafe ä»£ç å—
- åˆ†æç±»å‹ä¿¡æ¯

è¾“å‡ºæ–‡ä»¶ï¼š`output/your_crate/ast.json`

### ç¬¬ä¸‰æ­¥ï¼šç†è§£é˜¶æ®µï¼ˆå¯é€‰ï¼‰

ä½¿ç”¨ LLM ç†è§£ API è¯­ä¹‰ï¼š

```bash
python RustFuzz.py comprehend -L your_crate
```

è¿™ä¸€æ­¥ä¼šï¼š
- åˆ†æå‡½æ•°æ–‡æ¡£æ³¨é‡Š
- ç†è§£ API ä½¿ç”¨æ¨¡å¼
- è¯†åˆ«å‡½æ•°ä¹‹é—´çš„ä¾èµ–å…³ç³»

### ç¬¬å››æ­¥ï¼šç”Ÿæˆ Fuzz Target

```bash
# ç”Ÿæˆ 10 ä¸ª fuzz target
python RustFuzz.py generate -L your_crate --count 10

# ç”Ÿæˆè¦†ç›–æ‰€æœ‰å…¬å¼€ API çš„ fuzz target
python RustFuzz.py generate -L your_crate --task allcover

# é’ˆå¯¹ç‰¹å®šå‡½æ•°ç”Ÿæˆ
python RustFuzz.py generate -L your_crate --task given --functions "parse,process,validate"
```

ç”Ÿæˆçš„æ–‡ä»¶ä½äºï¼š`output/your_crate/fuzz_targets/`

### ç¬¬äº”æ­¥ï¼šè¿è¡Œ Fuzzing

```bash
# è¿è¡Œæ‰€æœ‰ fuzz target
python RustFuzz.py fuzz -L your_crate

# è¿è¡Œç‰¹å®š target
python RustFuzz.py fuzz -L your_crate --target fuzz_target_1

# æŒ‡å®šè¿è¡Œæ—¶é—´å’Œå¹¶è¡Œæ•°
python RustFuzz.py fuzz -L your_crate --timeout 7200 --jobs 4
```

### ç¬¬å…­æ­¥ï¼šåˆ†æç»“æœ

```bash
# åˆ†æ crash
python RustFuzz.py analyze -L your_crate

# æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
python RustFuzz.py stats -L your_crate

# æŸ¥çœ‹è¦†ç›–ç‡
python RustFuzz.py stats -L your_crate --coverage
```

---

## å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹ 1: æµ‹è¯• JSON è§£æåº“

å‡è®¾æˆ‘ä»¬è¦æµ‹è¯•ä¸€ä¸ª JSON è§£æåº“ï¼š

#### 1. é…ç½®

`libraries.toml`:
```toml
[my_json]
language = "rust"
crate_path = "/home/user/projects/my-json"
source_paths = ["src"]
output_path = "output/my_json"
features = ["serde"]
api_hints = [
    "parse() å‡½æ•°è§£æ JSON å­—ç¬¦ä¸²",
    "éœ€è¦å¤„ç†æ— æ•ˆçš„ UTF-8",
    "æ³¨æ„æ·±å±‚åµŒå¥—çš„ JSON"
]
```

#### 2. è¿è¡Œ

```bash
# é¢„å¤„ç†
python RustFuzz.py preprocess -L my_json

# ç”Ÿæˆ fuzz targetï¼ˆé‡ç‚¹æµ‹è¯•è§£æå‡½æ•°ï¼‰
python RustFuzz.py generate -L my_json --task given --functions "parse,from_str,from_slice"

# è¿è¡Œ fuzzingï¼ˆ6å°æ—¶ï¼‰
python RustFuzz.py fuzz -L my_json --timeout 21600
```

#### 3. æŸ¥çœ‹ç”Ÿæˆçš„ Fuzz Target

`output/my_json/fuzz_targets/fuzz_target_1.rs`:

```rust
#![no_main]
use libfuzzer_sys::fuzz_target;
use arbitrary::Arbitrary;

fuzz_target!(|data: &[u8]| {
    // å°è¯•å°†è¾“å…¥è§£æä¸º UTF-8
    if let Ok(s) = std::str::from_utf8(data) {
        // è°ƒç”¨è§£æå‡½æ•°
        let _ = my_json::parse(s);
    }
    
    // ä¹Ÿæµ‹è¯•é UTF-8 è¾“å…¥
    let _ = my_json::from_slice(data);
});
```

### æ¡ˆä¾‹ 2: æµ‹è¯•å›¾åƒå¤„ç†åº“

#### 1. é…ç½®

```toml
[image_proc]
language = "rust"
crate_path = "/home/user/projects/image-proc"
source_paths = ["src"]
output_path = "output/image_proc"
features = ["png", "jpeg"]
api_hints = [
    "decode() è§£ç å›¾åƒæ•°æ®",
    "éœ€è¦éªŒè¯å›¾åƒå°ºå¯¸",
    "æ³¨æ„æ•´æ•°æº¢å‡º"
]
```

#### 2. è¿è¡Œ

```bash
# å®Œæ•´æµç¨‹
python RustFuzz.py preprocess -L image_proc
python RustFuzz.py generate -L image_proc --count 15
python RustFuzz.py fuzz -L image_proc --timeout 3600

# åˆ†æç»“æœ
python RustFuzz.py analyze -L image_proc
```

### æ¡ˆä¾‹ 3: æµ‹è¯• Unsafe ä»£ç 

å¯¹äºåŒ…å«å¤§é‡ unsafe çš„é¡¹ç›®ï¼š

#### 1. é…ç½®

```toml
[unsafe_lib]
language = "rust"
crate_path = "/home/user/projects/unsafe-lib"
source_paths = ["src"]
output_path = "output/unsafe_lib"

# åœ¨ config.toml ä¸­
[preprocessor]
analyze_unsafe_blocks = true

[generator]
prioritize_unsafe = true
```

#### 2. è¿è¡Œ

```bash
python RustFuzz.py preprocess -L unsafe_lib
# å·¥å…·ä¼šè‡ªåŠ¨è¯†åˆ«å¹¶ä¼˜å…ˆæµ‹è¯•åŒ…å« unsafe çš„å‡½æ•°
python RustFuzz.py generate -L unsafe_lib --task allcover
python RustFuzz.py fuzz -L unsafe_lib
```

---

## é«˜çº§æŠ€å·§

### 1. æä¾›ç§å­è¾“å…¥

ä¸ºæé«˜ fuzzing æ•ˆç‡ï¼Œå¯ä»¥æä¾›åˆå§‹ç§å­ï¼š

```bash
# åœ¨ fuzz é¡¹ç›®ç›®å½•ä¸­åˆ›å»º corpus
mkdir -p output/your_crate/fuzz_project/fuzz/corpus/fuzz_target_1
# å°†ç§å­æ–‡ä»¶æ”¾å…¥è¯¥ç›®å½•
cp seed_files/* output/your_crate/fuzz_project/fuzz/corpus/fuzz_target_1/
```

### 2. ä½¿ç”¨å­—å…¸

åˆ›å»ºå­—å…¸æ–‡ä»¶æç¤º fuzzer æœ‰ç”¨çš„è¾“å…¥ç‰‡æ®µï¼š

`dictionary.txt`:
```
"{"
"}"
"["
"]"
":"
","
"null"
"true"
"false"
"\x00"
```

åœ¨ `config.toml` ä¸­æŒ‡å®šï¼š
```toml
[fuzzer]
dictionary_path = "dictionary.txt"
```

### 3. è‡ªå®šä¹‰ Fuzz Target

æ‰‹åŠ¨ç¼–è¾‘ç”Ÿæˆçš„ fuzz targetï¼Œæ·»åŠ ç‰¹å®šé€»è¾‘ï¼š

```rust
#![no_main]
use libfuzzer_sys::fuzz_target;

fuzz_target!(|data: &[u8]| {
    // è‡ªå®šä¹‰è¾“å…¥å¤„ç†
    if data.len() < 4 {
        return;
    }
    
    // åˆ†å‰²è¾“å…¥ç”¨äºä¸åŒå‚æ•°
    let (param1, param2) = data.split_at(data.len() / 2);
    
    // è°ƒç”¨ç›®æ ‡å‡½æ•°
    let _ = my_lib::complex_function(param1, param2);
});
```

### 4. ä½¿ç”¨ Arbitrary ç”Ÿæˆç»“æ„åŒ–è¾“å…¥

```rust
#![no_main]
use libfuzzer_sys::fuzz_target;
use arbitrary::Arbitrary;

#[derive(Arbitrary, Debug)]
struct Input {
    field1: u32,
    field2: String,
    field3: Vec<u8>,
}

fuzz_target!(|input: Input| {
    let _ = my_lib::process(
        input.field1,
        &input.field2,
        &input.field3
    );
});
```

### 5. å¹¶è¡Œ Fuzzing

åœ¨å¤šå°æœºå™¨æˆ–å¤šä¸ª CPU æ ¸å¿ƒä¸Šå¹¶è¡Œï¼š

```bash
# æœºå™¨ 1
python RustFuzz.py fuzz -L your_crate --jobs 8

# æœºå™¨ 2ï¼ˆä½¿ç”¨ç›¸åŒçš„ corpusï¼‰
# åŒæ­¥ corpus ç›®å½•
rsync -av machine1:output/your_crate/fuzz_project/fuzz/corpus/ ./corpus/
python RustFuzz.py fuzz -L your_crate --jobs 8
```

### 6. æŒç»­é›†æˆ

åœ¨ CI/CD ä¸­é›†æˆ fuzzingï¼š

`.github/workflows/fuzz.yml`:
```yaml
name: Fuzzing
on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©è¿è¡Œ

jobs:
  fuzz:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz
      - name: Install Python deps
        run: pip install -r requirements.txt
      - name: Run fuzzing
        run: |
          python RustFuzz.py preprocess -L my_crate
          python RustFuzz.py generate -L my_crate --count 5
          python RustFuzz.py fuzz -L my_crate --timeout 3600
      - name: Upload crashes
        if: failure()
        uses: actions/upload-artifact@v2
        with:
          name: crashes
          path: output/*/crash_report.json
```

---

## å¸¸è§é—®é¢˜

### Q1: ç”Ÿæˆçš„ fuzz target ç¼–è¯‘å¤±è´¥ï¼Ÿ

**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š

1. ç¡®ä¿ `Cargo.toml` ä¸­åŒ…å«å¿…è¦çš„ä¾èµ–ï¼š
```toml
[dependencies]
libfuzzer-sys = "0.4"
arbitrary = "1.0"
```

2. æ£€æŸ¥å¯¼å…¥è·¯å¾„æ˜¯å¦æ­£ç¡®
3. æ‰‹åŠ¨ä¿®æ­£ç”Ÿæˆçš„ä»£ç ä¸­çš„ç±»å‹é”™è¯¯

### Q2: Fuzzing è¿è¡Œå¾ˆæ…¢ï¼Œæ²¡æœ‰å‘ç°ä»»ä½•é—®é¢˜ï¼Ÿ

**A**: å°è¯•ï¼š

1. æä¾›æ›´å¥½çš„ç§å­è¾“å…¥
2. å¢åŠ è¿è¡Œæ—¶é—´
3. è°ƒæ•´ LLM prompt ç”Ÿæˆæ›´æœ‰é’ˆå¯¹æ€§çš„æµ‹è¯•
4. æ‰‹åŠ¨ç¼–è¾‘ fuzz target æé«˜æ•ˆç‡

### Q3: å¦‚ä½•è°ƒè¯• crashï¼Ÿ

**A**: 

```bash
# ä½¿ç”¨ crash è¾“å…¥é‡ç°
cargo fuzz run fuzz_target_1 output/crash-xxx

# ä½¿ç”¨ debugger
rust-lldb target/x86_64-unknown-linux-gnu/release/fuzz_target_1 output/crash-xxx
```

### Q4: å¦‚ä½•æµ‹è¯•ç§æœ‰å‡½æ•°ï¼Ÿ

**A**: 

1. åœ¨ `libraries.toml` ä¸­è®¾ç½®ï¼š
```toml
include_private = true
```

2. åœ¨è¢«æµ‹è¯•çš„ crate ä¸­æ·»åŠ ï¼š
```rust
#[cfg(fuzzing)]
pub use private_module::private_function;
```

### Q5: LLM ç”Ÿæˆçš„ä»£ç è´¨é‡ä¸é«˜ï¼Ÿ

**A**: 

1. ä½¿ç”¨æ›´å¼ºå¤§çš„æ¨¡å‹ï¼ˆå¦‚ GPT-4ï¼‰
2. åœ¨ `libraries.toml` ä¸­æä¾›æ›´è¯¦ç»†çš„ `api_hints`
3. æ‰‹åŠ¨ç¼–è¾‘å’Œæ”¹è¿›ç”Ÿæˆçš„ä»£ç 
4. è°ƒæ•´ prompt template

### Q6: å¦‚ä½•æé«˜è¦†ç›–ç‡ï¼Ÿ

**A**: 

1. ç”Ÿæˆæ›´å¤šæ ·åŒ–çš„ fuzz target
2. ä½¿ç”¨ç»“æ„åŒ–è¾“å…¥ï¼ˆArbitraryï¼‰
3. æä¾›æœ‰é’ˆå¯¹æ€§çš„ç§å­
4. ç»“åˆä»£ç è¦†ç›–ç‡åˆ†æè°ƒæ•´ç­–ç•¥

---

## æœ€ä½³å®è·µ

### 1. å¾ªåºæ¸è¿›

- ä»ç®€å•çš„å‡½æ•°å¼€å§‹
- é€æ­¥å¢åŠ å¤æ‚åº¦
- å®šæœŸæŸ¥çœ‹å’Œåˆ†æç»“æœ

### 2. ä¸“æ³¨é«˜é£é™©åŒºåŸŸ

- ä¼˜å…ˆæµ‹è¯• unsafe ä»£ç 
- é‡ç‚¹å…³æ³¨è§£æå’Œååºåˆ—åŒ–
- æµ‹è¯•è¾¹ç•Œæ¡ä»¶å¤„ç†

### 3. ç»“åˆå…¶ä»–æµ‹è¯•

- å•å…ƒæµ‹è¯•è¦†ç›–æ­£å¸¸æƒ…å†µ
- Fuzzing å‘ç°è¾¹ç•Œæƒ…å†µ
- é›†æˆæµ‹è¯•éªŒè¯æ•´ä½“è¡Œä¸º

### 4. æŒç»­ä¼˜åŒ–

- å®šæœŸæ›´æ–° fuzz target
- æ ¹æ®å‘ç°è°ƒæ•´ç­–ç•¥
- ä¿æŒ corpus çš„å¤šæ ·æ€§

---

## æ€»ç»“

RustFuzz æä¾›äº†ä¸€ä¸ªç«¯åˆ°ç«¯çš„ Rust æ¼æ´æŒ–æ˜è§£å†³æ–¹æ¡ˆï¼š

1. **è‡ªåŠ¨åŒ–**: ä»ä»£ç åˆ†æåˆ° fuzz target ç”Ÿæˆå…¨è‡ªåŠ¨
2. **æ™ºèƒ½åŒ–**: åˆ©ç”¨ LLM ç†è§£ä»£ç è¯­ä¹‰
3. **é’ˆå¯¹æ€§**: ä¸“é—¨ä¼˜åŒ– Rust ç‰¹æ€§
4. **çµæ´»æ€§**: æ”¯æŒæ‰‹åŠ¨è°ƒæ•´å’Œä¼˜åŒ–

é€šè¿‡æœ¬æ•™ç¨‹ï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š
- âœ… é…ç½® RustFuzz ç¯å¢ƒ
- âœ… åˆ†æå’Œç”Ÿæˆ fuzz target
- âœ… è¿è¡Œ fuzzing å¹¶åˆ†æç»“æœ
- âœ… åº”ç”¨é«˜çº§æŠ€å·§æé«˜æ•ˆç‡

ç¥ fuzzing æ„‰å¿«ï¼ğŸ¦€ğŸ”
