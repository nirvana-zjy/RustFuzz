# é…ç½®æ–‡ä»¶è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ RustFuzz çš„æ‰€æœ‰é…ç½®é€‰é¡¹ã€‚

## ğŸ“‹ é…ç½®æ–‡ä»¶æ¦‚è¿°

RustFuzz ä½¿ç”¨ä¸¤ä¸ªä¸»è¦é…ç½®æ–‡ä»¶ï¼š

1. **config.toml** - å…¨å±€é…ç½®ï¼ˆLLMã€é¢„å¤„ç†å™¨ã€ç”Ÿæˆå™¨ç­‰ï¼‰
2. **libraries.toml** - ç›®æ ‡åº“é…ç½®ï¼ˆæ¯ä¸ªè¦æµ‹è¯•çš„ crateï¼‰

## âš™ï¸ config.toml è¯¦è§£

### [llm] - LLM é…ç½®

```toml
[llm]
# OpenAI API é…ç½®
openai_api_key = ""           # OpenAI API å¯†é’¥
openai_api_base = "https://api.openai.com/v1"  # API ç«¯ç‚¹
openai_model = "gpt-4"        # ä½¿ç”¨çš„æ¨¡å‹

# Ollama æœ¬åœ°æ¨¡å‹é…ç½®
use_ollama = false            # æ˜¯å¦ä½¿ç”¨ Ollama
ollama_host = "http://localhost:11434"  # Ollama åœ°å€
ollama_model = "codellama:13b"  # æ¨¡å‹åç§°

# Azure OpenAI é…ç½®ï¼ˆå¯é€‰ï¼‰
use_azure = false
azure_endpoint = ""
azure_api_key = ""
azure_deployment = ""
```

**è¯´æ˜**ï¼š
- åªéœ€é…ç½®ä¸€ç§ LLMï¼ˆOpenAI æˆ– Ollamaï¼‰
- OpenAIï¼šéœ€è¦ API Keyï¼Œä»˜è´¹ä½¿ç”¨ï¼Œè´¨é‡é«˜
- Ollamaï¼šæœ¬åœ°è¿è¡Œï¼Œå…è´¹ï¼Œä½†éœ€è¦å¼ºå¤§çš„ç¡¬ä»¶
- æ¨èä½¿ç”¨ `gpt-4` è·å¾—æœ€ä½³ä»£ç ç”Ÿæˆè´¨é‡

### [preprocessor] - é¢„å¤„ç†å™¨é…ç½®

```toml
[preprocessor]
# æ˜¯å¦æå–æµ‹è¯•ç”¨ä¾‹ä½œä¸º API ä½¿ç”¨ç¤ºä¾‹
extract_test_cases = true

# æ˜¯å¦æå–æ–‡æ¡£ç¤ºä¾‹ä»£ç 
extract_doc_examples = true

# æ˜¯å¦ç‰¹åˆ«åˆ†æ unsafe ä»£ç å—
analyze_unsafe_blocks = true

# æ˜¯å¦åˆ†æ panic ç‚¹
analyze_panic_points = true

# æ˜¯å¦å¯¼å‡º API å…³è”æ€§ä¸º CSVï¼ˆè°ƒè¯•ç”¨ï¼‰
dump_relevance_as_csv = false

# æ˜¯å¦å¯¼å‡ºè°ƒç”¨å›¾ï¼ˆè°ƒè¯•ç”¨ï¼‰
dump_call_graph = false

# æ˜¯å¦è¿è¡Œç±»å‹æ£€æŸ¥
run_type_check = true
```

**è¯´æ˜**ï¼š
- `extract_test_cases`: ä»æµ‹è¯•ä»£ç å­¦ä¹  API ä½¿ç”¨æ¨¡å¼
- `analyze_unsafe_blocks`: unsafe æ˜¯æ¼æ´é«˜å‘åŒºï¼Œå»ºè®®å¼€å¯
- `dump_*`: ç”¨äºè°ƒè¯•ï¼Œä¼šç”Ÿæˆå¤§é‡æ–‡ä»¶ï¼Œæ—¥å¸¸ä½¿ç”¨å»ºè®®å…³é—­

### [comprehender] - ç†è§£å™¨é…ç½®

```toml
[comprehender]
# ç”¨äº RAG åµŒå…¥çš„ LLM
embedding_llm = "text-embedding-ada-002"

# ç”¨äºç†è§£çš„ LLMï¼ˆç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤ LLMï¼‰
comprehension_llm = ""

# RAG æ£€ç´¢æ—¶è¿”å›çš„æ–‡æ¡£æ•°é‡
retrieve_top_k = 3

# æ¯æ‰¹å¤„ç†çš„å‡½æ•°æ•°é‡
function_batch_size = 12

# æ˜¯å¦ç†è§£ trait çº¦æŸ
comprehend_trait_bounds = true

# æ˜¯å¦ç†è§£ç”Ÿå‘½å‘¨æœŸçº¦æŸ
comprehend_lifetimes = true
```

**è¯´æ˜**ï¼š
- `retrieve_top_k`: æ•°å€¼è¶Šå¤§ï¼Œä¸Šä¸‹æ–‡è¶Šä¸°å¯Œï¼Œä½† token æ¶ˆè€—è¶Šå¤š
- `function_batch_size`: æ ¹æ® LLM çš„ token é™åˆ¶è°ƒæ•´

### [generator] - ç”Ÿæˆå™¨é…ç½®

```toml
[generator]
# ç”¨äºç”Ÿæˆçš„ LLMï¼ˆç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤ LLMï¼‰
generation_llm = ""

# æ”¶é›†ä¿¡æ¯æ—¶çš„éå†æ·±åº¦
collect_depth = 3

# å¦‚æœæœ‰å¤šä¸ªåŒåå®šä¹‰ï¼Œæ˜¯å¦åªé€‰æ‹©ä¸€ä¸ª
collect_one_def_in_same_names = true

# æ¯ä¸ª fuzz target åŒ…å«çš„å‡½æ•°æ•°é‡
function_set_size = 3

# æœ€å¤§ç”Ÿæˆè½®æ¬¡
max_rounds = 50

# å•ä¸ª fuzz target çš„æœ€å¤§é‡è¯•æ¬¡æ•°
max_retries_per_target = 3

# æ˜¯å¦è‡ªåŠ¨ç”Ÿæˆ Arbitrary trait å®ç°
generate_arbitrary = true

# æ˜¯å¦ä¼˜å…ˆæµ‹è¯•åŒ…å« unsafe çš„å‡½æ•°
prioritize_unsafe = true

# æ˜¯å¦ç”Ÿæˆç»“æ„åŒ–è¾“å…¥
generate_structured_input = true

# è¾“å…¥æ•°æ®çš„æœ€å¤§å¤§å°ï¼ˆå­—èŠ‚ï¼‰
max_input_size = 4096
```

**é‡è¦å‚æ•°**ï¼š
- `function_set_size`: 3-5 ä¸ªå‡½æ•°é€šå¸¸æ•ˆæœæœ€å¥½
- `max_rounds`: æ§åˆ¶æ€»ç”Ÿæˆæ•°é‡
- `prioritize_unsafe`: å¼ºçƒˆå»ºè®®å¼€å¯ï¼Œunsafe ä»£ç æœ€å®¹æ˜“å‡ºé—®é¢˜
- `max_input_size`: é™åˆ¶ç”Ÿæˆçš„è¾“å…¥å¤§å°ï¼Œé¿å…æ— é™å¾ªç¯

### [fuzzer] - Fuzzing é…ç½®

```toml
[fuzzer]
# Fuzzing å¼•æ“
engine = "libfuzzer"  # å¯é€‰: "libfuzzer", "afl++", "honggfuzz"

# å¹¶è¡Œ job æ•°é‡ï¼ˆ0 è¡¨ç¤ºä½¿ç”¨ CPU æ ¸å¿ƒæ•°ï¼‰
jobs = 0

# å•ä¸ª target çš„è¿è¡Œæ—¶é—´ï¼ˆç§’ï¼Œ0 è¡¨ç¤ºæ— é™åˆ¶ï¼‰
timeout = 3600

# æ¯ä¸ª target çš„æœ€å¤§æ€»è¿è¡Œæ¬¡æ•°
max_total_runs = 100000000

# Sanitizer é…ç½®
sanitizers = ["address"]  # å¯é€‰: "address", "memory", "leak", "thread"

# æ˜¯å¦ä½¿ç”¨è¦†ç›–ç‡å¼•å¯¼
use_coverage = true

# åˆå§‹è¯­æ–™åº“ç›®å½•ï¼ˆå¯é€‰ï¼‰
corpus_dir = ""

# å­—å…¸æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼‰
dictionary_path = ""
```

**è¯´æ˜**ï¼š
- `engine`: libfuzzer æ˜¯é»˜è®¤å’Œæ¨èé€‰é¡¹
- `jobs`: è®¾ä¸º 0 è‡ªåŠ¨ä½¿ç”¨æ‰€æœ‰ CPU æ ¸å¿ƒ
- `timeout`: æ ¹æ®é¡¹ç›®å¤æ‚åº¦è°ƒæ•´ï¼Œå»ºè®®è‡³å°‘ 1 å°æ—¶
- `sanitizers`: address å¯ä»¥æ£€æµ‹å†…å­˜å®‰å…¨é—®é¢˜

### [analyzer] - åˆ†æå™¨é…ç½®

```toml
[analyzer]
# æ˜¯å¦è‡ªåŠ¨å»é‡ crash
deduplicate_crashes = true

# æ˜¯å¦ç”Ÿæˆ crash å¤ç°è„šæœ¬
generate_reproduction_script = true

# æ˜¯å¦è‡ªåŠ¨æœ€å°åŒ– crash è¾“å…¥
minimize_crash_input = true

# æ˜¯å¦æ”¶é›†è¦†ç›–ç‡ä¿¡æ¯
collect_coverage = true
```

### [statistics] - ç»Ÿè®¡é…ç½®

```toml
[statistics]
# æ˜¯å¦ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Š
generate_visualization = true

# æ˜¯å¦å¯¼å‡ºè¯¦ç»†ç»Ÿè®¡æ•°æ®
export_detailed_stats = true

# æŠ¥å‘Šæ ¼å¼
report_format = "html"  # å¯é€‰: "html", "json", "markdown"
```

### [debug] - è°ƒè¯•é…ç½®

```toml
[debug]
# æ—¥å¿—çº§åˆ«
log_level = "INFO"  # å¯é€‰: "DEBUG", "INFO", "WARNING", "ERROR"

# æ˜¯å¦ä¿å­˜ä¸­é—´ç»“æœ
save_intermediate_results = true

# æ˜¯å¦ä¿å­˜ç”Ÿæˆçš„ prompt
save_prompts = true

# æ˜¯å¦ä¿å­˜ LLM å“åº”
save_llm_responses = true
```

## ğŸ“¦ libraries.toml è¯¦è§£

### åŸºæœ¬é…ç½®

```toml
[library_name]  # åº“çš„å”¯ä¸€æ ‡è¯†ç¬¦
language = "rust"  # å¿…é¡»æ˜¯ "rust"

# Crate è·¯å¾„ï¼ˆç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„ï¼‰
crate_path = "/path/to/your/crate"

# æºä»£ç è·¯å¾„ï¼ˆç›¸å¯¹äº crate_pathï¼‰
source_paths = ["src"]

# æµ‹è¯•ä»£ç è·¯å¾„ï¼ˆå¯é€‰ï¼‰
test_paths = ["tests"]

# è¾“å‡ºè·¯å¾„ï¼ˆä¿å­˜åˆ†æç»“æœå’Œç”Ÿæˆçš„ fuzz targetï¼‰
output_path = "output/library_name"
```

### é«˜çº§é…ç½®

```toml
# è¦æµ‹è¯•çš„ç›®æ ‡æ¨¡å—ï¼ˆç•™ç©ºåˆ™æµ‹è¯•æ‰€æœ‰å…¬å¼€æ¨¡å—ï¼‰
target_modules = ["parser", "serializer"]

# æ’é™¤çš„è·¯å¾„
exclude_paths = ["benches", "examples"]

# Cargo featuresï¼ˆå¯ç”¨ç‰¹å®šåŠŸèƒ½ï¼‰
features = ["serde", "tokio"]

# é¢å¤–çš„ä¾èµ–ï¼ˆå¦‚æœ fuzz target éœ€è¦ï¼‰
extra_dependencies = ["arbitrary"]

# æ˜¯å¦åŒ…å«ç§æœ‰å‡½æ•°ï¼ˆé€šå¸¸åªæµ‹è¯•å…¬å¼€ APIï¼‰
include_private = false

# API ä½¿ç”¨æç¤ºï¼ˆå¸®åŠ© LLM ç”Ÿæˆæ›´å¥½çš„ä»£ç ï¼‰
api_hints = [
    "parse() å‡½æ•°ç”¨äºè§£æè¾“å…¥",
    "å¤„ç†å‰åº”æ£€æŸ¥è¾“å…¥é•¿åº¦"
]

# å·²çŸ¥çš„ unsafe å‡½æ•°ï¼ˆä¼˜å…ˆæµ‹è¯•ï¼‰
priority_unsafe_functions = ["raw_pointer_access", "transmute_data"]

# é‡ç‚¹æµ‹è¯•çš„ trait å®ç°
priority_traits = ["FromStr", "TryFrom"]

# æ˜¯å¦éœ€è¦å¼‚æ­¥è¿è¡Œæ—¶
requires_runtime = false

# æœ€å¤§å‡½æ•°å¤æ‚åº¦ï¼ˆè·³è¿‡è¿‡äºå¤æ‚çš„å‡½æ•°ï¼‰
max_function_complexity = 100
```

## ğŸ“ é…ç½®ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šæµ‹è¯• JSON åº“

```toml
[my_json]
language = "rust"
crate_path = "/home/user/projects/my-json"
source_paths = ["src"]
test_paths = ["tests"]
output_path = "output/my_json"
target_modules = ["parser", "serializer"]
features = ["serde"]
api_hints = [
    "parse() è§£æ JSON å­—ç¬¦ä¸²",
    "éœ€è¦å¤„ç†æ— æ•ˆçš„ UTF-8",
    "æ³¨æ„æ·±å±‚åµŒå¥—çš„ JSON"
]
prioritize_unsafe = true
```

### ç¤ºä¾‹ 2ï¼šæµ‹è¯•å›¾åƒå¤„ç†åº“

```toml
[image_lib]
language = "rust"
crate_path = "/home/user/projects/image-lib"
source_paths = ["src"]
output_path = "output/image_lib"
target_modules = ["decode", "encode"]
features = ["png", "jpeg"]
api_hints = [
    "decode() è§£ç å›¾åƒæ•°æ®",
    "éœ€è¦éªŒè¯å›¾åƒå°ºå¯¸",
    "æ³¨æ„æ•´æ•°æº¢å‡º"
]
max_input_size = 10485760  # 10MB
```

### ç¤ºä¾‹ 3ï¼šæµ‹è¯•å¼‚æ­¥ç½‘ç»œåº“

```toml
[async_net]
language = "rust"
crate_path = "/home/user/projects/async-net"
source_paths = ["src"]
output_path = "output/async_net"
target_modules = ["client", "server"]
features = ["tokio"]
requires_runtime = true
priority_traits = ["Future", "Stream"]
```

## ğŸ¯ é…ç½®æœ€ä½³å®è·µ

### 1. LLM é€‰æ‹©

**å¼€å‘é˜¶æ®µ**ï¼š
- ä½¿ç”¨ Ollama + codellama:13bï¼ˆæœ¬åœ°ï¼Œå¿«é€Ÿè¿­ä»£ï¼‰

**ç”Ÿäº§ä½¿ç”¨**ï¼š
- ä½¿ç”¨ OpenAI GPT-4ï¼ˆè´¨é‡æœ€é«˜ï¼‰

### 2. å‡½æ•°é›†åˆå¤§å°

```toml
function_set_size = 3  # ç®€å• API
function_set_size = 5  # å¤æ‚ API
function_set_size = 1  # å•å‡½æ•°æ·±åº¦æµ‹è¯•
```

### 3. è¿è¡Œæ—¶é—´

```toml
timeout = 300    # 5åˆ†é’Ÿ - å¿«é€Ÿæµ‹è¯•
timeout = 3600   # 1å°æ—¶ - æ—¥å¸¸ä½¿ç”¨
timeout = 86400  # 24å°æ—¶ - æ·±åº¦æŒ–æ˜
```

### 4. å†…å­˜æ§åˆ¶

```toml
max_input_size = 1024      # 1KB - ç®€å•è¾“å…¥
max_input_size = 4096      # 4KB - é»˜è®¤
max_input_size = 1048576   # 1MB - å¤§æ•°æ®å¤„ç†
```

## ğŸ” å¸¸è§é…ç½®é—®é¢˜

### Q: å¦‚ä½•åŠ å¿«ç”Ÿæˆé€Ÿåº¦ï¼Ÿ
**A**: 
```toml
[generator]
function_set_size = 1  # å‡å°‘å‡½æ•°æ•°é‡
collect_depth = 2       # å‡å°‘æ”¶é›†æ·±åº¦
```

### Q: å¦‚ä½•æé«˜ç”Ÿæˆè´¨é‡ï¼Ÿ
**A**:
```toml
[llm]
openai_model = "gpt-4"  # ä½¿ç”¨æ›´å¼ºçš„æ¨¡å‹

[generator]
max_retries_per_target = 5  # å¢åŠ é‡è¯•æ¬¡æ•°
```

### Q: å¦‚ä½•å‡å°‘ token æ¶ˆè€—ï¼Ÿ
**A**:
```toml
[comprehender]
retrieve_top_k = 1  # å‡å°‘æ£€ç´¢æ•°é‡

[generator]
collect_one_def_in_same_names = true  # åªæ”¶é›†ä¸€ä¸ªå®šä¹‰
```

### Q: å¦‚ä½•ä¸“æ³¨æµ‹è¯• unsafe ä»£ç ï¼Ÿ
**A**:
```toml
[preprocessor]
analyze_unsafe_blocks = true

[generator]
prioritize_unsafe = true

[libraries.your_lib]
priority_unsafe_functions = ["func1", "func2"]
```

## ğŸ“Š é…ç½®æ¨¡æ¿

å®Œæ•´çš„é…ç½®æ¨¡æ¿è§é¡¹ç›®æ ¹ç›®å½•ï¼š
- `config.toml` - å…¨å±€é…ç½®æ¨¡æ¿
- `libraries.toml` - åº“é…ç½®æ¨¡æ¿
- `examples/serde_json_config.toml` - å®é™…é¡¹ç›®ç¤ºä¾‹

## ğŸ’¡ é…ç½®å»ºè®®

1. **é¦–æ¬¡ä½¿ç”¨**: ä½¿ç”¨é»˜è®¤é…ç½®ï¼Œä¸åšä¿®æ”¹
2. **ç†Ÿæ‚‰å**: æ ¹æ®é¡¹ç›®ç‰¹ç‚¹è°ƒæ•´å‚æ•°
3. **é‡åˆ°é—®é¢˜**: å¯ç”¨ debug æ¨¡å¼æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
4. **ä¼˜åŒ–æ€§èƒ½**: æ ¹æ®ç¡¬ä»¶å’Œéœ€æ±‚å¹³è¡¡è´¨é‡ä¸é€Ÿåº¦

---

é…ç½®å®Œæˆåï¼Œä½ å°±å¯ä»¥å¼€å§‹ä½¿ç”¨ RustFuzz äº†ï¼

**ä¸‹ä¸€æ­¥**: æŸ¥çœ‹ [å¿«é€Ÿå¼€å§‹æŒ‡å—](01-å¿«é€Ÿå¼€å§‹.md) æˆ– [å®Œæ•´æ•™ç¨‹](02-å®Œæ•´æ•™ç¨‹.md)
